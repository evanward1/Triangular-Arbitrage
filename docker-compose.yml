services:
  arbitrage-dashboard:
    build:
      context: .
      dockerfile: Dockerfile
      target: base
    container_name: arbitrage-dashboard
    ports:
      - "8000:8000"
    environment:
      # Trading Configuration
      - TRADING_MODE=paper
      - PAPER_USDT=1000
      - PAPER_USDC=1000

      # Filter Configuration (leave empty for all symbols)
      - SYMBOL_ALLOWLIST=
      - TRIANGLE_BASES=
      - EXCLUDE_SYMBOLS=

      # Trading Parameters
      - MIN_PROFIT_THRESHOLD=0.5
      - MAX_POSITION_SIZE=100

      # Polling & Display
      - POLL_SEC=10
      - VERBOSITY=normal
      - TOPN=3
      - RUN_MIN=3

      # API Keys (for live trading - set in .env file)
      - KRAKEN_API_KEY=${KRAKEN_API_KEY:-}
      - KRAKEN_API_SECRET=${KRAKEN_API_SECRET:-}
      - BINANCE_API_KEY=${BINANCE_API_KEY:-}
      - BINANCE_API_SECRET=${BINANCE_API_SECRET:-}
      - COINBASE_API_KEY=${COINBASE_API_KEY:-}
      - COINBASE_API_SECRET=${COINBASE_API_SECRET:-}

    volumes:
      - ./logs:/app/logs
      - trade-state:/app/data
    restart: unless-stopped
    networks:
      - arbitrage-net
    healthcheck:
      # Fail if the heartbeat file is missing or older than 60 seconds,
      # indicating the async event loop has stalled.
      test:
        - "CMD"
        - "python3"
        - "-c"
        - "import os, time; age = time.time() - os.path.getmtime('/tmp/heartbeat'); exit(0 if age < 60 else 1)"
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  redis:
    image: redis:7-alpine
    container_name: redis
    restart: unless-stopped
    networks:
      - arbitrage-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 15s
      timeout: 5s
      retries: 3

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.retention.time=15d"
    restart: unless-stopped
    networks:
      - arbitrage-net
    depends_on:
      - arbitrage-dashboard
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
    volumes:
      - grafana-data:/var/lib/grafana
    restart: unless-stopped
    networks:
      - arbitrage-net
    depends_on:
      - prometheus
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  arbitrage-net:
    driver: bridge

volumes:
  trade-state:
  prometheus-data:
  grafana-data:
